name: 'Update README metadata'

on:
  pull_request_target:
    branches:
      - main
      - at/readme-external
    paths:
      - "charts/**"

# Limit permissions to only what's needed
permissions:
  contents: write  # Need write permission to commit changes
  pull-requests: write

jobs:
  update-readme-metadata:
    runs-on: ubuntu-4
    steps:
      - name: Install readme-generator-for-helm
        run: npm install -g @bitnami/readme-generator-for-helm
        
      - name: Check if PR is from a fork
        id: check-fork
        run: |
          if [[ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi
      
      # For internal PRs, checkout code normally
      - name: Checkout code (Internal PR)
        if: steps.check-fork.outputs.is_fork == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necessary for getting a complete history for diffs
          ref: ${{ github.event.pull_request.head.sha }}
      
      # For fork PRs, checkout with extra security measures
      - name: Checkout code (Fork PR)
        if: steps.check-fork.outputs.is_fork == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necessary for getting a complete history for diffs
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false  # Security measure for pull_request_target
      
      - name: Get modified charts
        id: get-modified-charts
        run: |
          # GitHub Actions checks out a merge commit by default
          # We can use git diff against the PR base to find changed files
          BASE_SHA=$(git merge-base ${{ github.event.pull_request.base.sha }} HEAD)
          
          # Get all modified values.yaml files
          paths=$(git diff --name-only $BASE_SHA HEAD | grep 'charts/.*/values.yaml' | cut -d/ -f1,2 | uniq | tr '\n' ' ')
          
          echo "Modified charts: $paths"
          echo "paths=${paths}" >> $GITHUB_ENV

      # Only run for internal PRs or if there are modified values.yaml files
      - name: Execute readme-generator-for-helm (Internal PR)
        if: env.paths != '' && steps.check-fork.outputs.is_fork == 'false'
        run: |
          IFS=' ' read -ra ADDR <<< "$paths"
          echo "Updating READMEs for modified charts: ${ADDR[@]}"
          for chart in "${ADDR[@]}"; do
            echo "Updating README.md for ${chart}"
            readme-generator --values "${chart}/values.yaml" --readme "${chart}/README.md"
            if [[ $? -ne 0 ]]; then
              echo "Error: Failed to update README for ${chart}"
              exit 1
            fi
          done

      # Only commit changes for internal PRs
      - name: Commit and Push Changes (Internal PR)
        if: env.paths != '' && steps.check-fork.outputs.is_fork == 'false'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Update README and values.schema.json for modified charts

      # For fork PRs, verify what changes would be needed but don't commit them
      - name: Check README changes needed (Fork PR)
        if: env.paths != '' && steps.check-fork.outputs.is_fork == 'true'
        id: check-changes
        run: |
          # Create a directory to store the generated README files
          mkdir -p temp_readme_files
          
          IFS=' ' read -ra ADDR <<< "$paths"
          for chart in "${ADDR[@]}"; do
            echo "Checking README changes for ${chart}"
            # Generate README to a temporary file to see what changes would be needed
            readme-generator --values "${chart}/values.yaml" --readme "temp_readme_files/${chart##*/}_README.md"
          done

      # For fork PRs, create a comment with instructions
      - name: Prepare Comment Content (Fork PR)
        if: env.paths != '' && steps.check-fork.outputs.is_fork == 'true'
        id: prepare-comment
        run: |
          # Create a temporary file for the comment
          echo "## README Update Required" > comment.md
          echo "" >> comment.md
          echo "This PR is from a fork. The README generator has detected changes that need to be made to the README files." >> comment.md
          echo "" >> comment.md
          echo "Please update the following README files manually:" >> comment.md
          
          IFS=' ' read -ra ADDR <<< "$paths"
          for chart in "${ADDR[@]}"; do
            echo "- ${chart}/README.md" >> comment.md
          done
          
          echo "" >> comment.md
          echo "You can use the readme-generator tool to generate the updated README content:" >> comment.md
          echo "" >> comment.md
          echo '```bash' >> comment.md
          echo "npm install -g @bitnami/readme-generator-for-helm" >> comment.md
          
          for chart in "${ADDR[@]}"; do
            echo "readme-generator --values ${chart}/values.yaml --readme ${chart}/README.md" >> comment.md
          done
          
          echo '```' >> comment.md

      - name: Create PR Comment with README Changes (Fork PR)
        if: env.paths != '' && steps.check-fork.outputs.is_fork == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
          reactions: 'eyes'
